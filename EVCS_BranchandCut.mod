///////////////////////////////////////////////////////////////
// EVmodel_full.mod - Mô hình tối ưu MOMIP đầy đủ (gộp dữ liệu)
///////////////////////////////////////////////////////////////

// Tập hợp
{string} POINTS = {
  "LK1","LK2","LK3","LK4","LK5","LK6","LK7","LK8","LK9","LK10",
  "LK11","LK12","LK13","LK14","LK15","LK16","LK17","LK18","LK19","LK20",
  "LK21","LK22","LK23","LK24","LK25","LK26","LK27","LK28","LK29",
  "BT1","BT2","BT3","BT4","CC-HH1","CC-HH2","CC-BDX"
};

{string} STATIONS = {
  "CC-TM1","CC-HH1","CC-TT1","CC-TM2","CC-TM3","CC-BDX","CC-HH2","CC-TLC"
};

{string} TYPES = {"xe_may", "oto5", "oto7", "taxi5", "taxi7", "bus"};

// Tham số
float SCF[TYPES] = [0.35, 0.35, 0.35, 0.34, 0.34, 0.44];
float area[TYPES] = [1.48, 12.5, 13.2, 12.5, 13.2, 40.0];
float power[TYPES] = [3.5, 11, 22, 11, 22, 150];

float alpha = 0.00036;
float beta = 0.00215;
float w1 = 0.33;
float w2 = 0.33;
float w3 = 0.33;

int DIST[POINTS][STATIONS] = [
  [220,1120,1300,1050,970,1600,800,1240],
  [210,1110,1290,1040,960,1590,790,1230],
  [200,1100,1280,1030,950,1580,780,1220],
  [190,1090,1270,1020,940,1570,770,1210],
  [180,1080,1260,1010,930,1560,760,1200],
  [170,1070,1250,1000,920,1550,750,1190],
  [160,1060,1240,990,910,1540,740,1180],
  [150,1050,1230,980,900,1530,730,1170],
  [140,1040,1220,970,890,1520,720,1160],
  [130,1030,1210,960,880,1510,710,1150],
  [120,1020,1200,950,870,1500,700,1140],
  [110,1010,1190,940,860,1490,690,1130],
  [100,1000,1180,930,850,1480,680,1120],
  [ 90, 990,1170,920,840,1470,670,1110],
  [ 80, 980,1160,910,830,1460,660,1100],
  [ 70, 970,1150,900,820,1450,650,1090],
  [ 60, 960,1140,890,810,1440,640,1080],
  [ 50, 950,1130,880,800,1430,630,1070],
  [ 40, 940,1120,870,790,1420,620,1060],
  [ 30, 930,1110,860,780,1410,610,1050],
  [ 20, 920,1100,850,770,1400,600,1040],
  [ 10, 910,1090,840,760,1390,590,1030],
  [ 15, 890,1070,820,740,1370,570,1010],
  [ 25, 880,1060,810,730,1360,560,1000],
  [ 35, 870,1050,800,720,1350,550, 990],
  [ 45, 860,1040,790,710,1340,540, 980],
  [ 55, 850,1030,780,700,1330,530, 970],
  [ 65, 840,1020,770,690,1320,520, 960],
  [ 75, 830,1010,760,680,1310,510, 950],
  [ 85, 820,1000,750,670,1300,500, 940],
  [ 95, 810, 990,740,660,1290,490, 930],
  [105, 800, 980,730,650,1280,480, 920],
  [115, 790, 970,720,640,1270,470, 910],
  [125, 780, 960,710,630,1260,460, 900],
  [135, 770, 950,700,620,1250,450, 890],
  [145, 760, 940,690,610,1240,440, 880]
];

int EVcount[POINTS][TYPES] = [
  [35, 5, 2, 0, 0, 0], [38, 7, 1, 0, 0, 0], [40, 6, 3, 0, 0, 0], [41, 5, 2, 0, 0, 0], [39, 6, 1, 0, 0, 0],
  [36, 6, 2, 0, 0, 0], [34, 7, 3, 0, 0, 0], [37, 6, 2, 0, 0, 0], [38, 5, 3, 0, 0, 0], [36, 6, 2, 0, 0, 0],
  [35, 5, 2, 0, 0, 0], [37, 7, 1, 0, 0, 0], [39, 6, 3, 0, 0, 0], [38, 5, 2, 0, 0, 0], [36, 6, 1, 0, 0, 0],
  [37, 5, 3, 0, 0, 0], [38, 6, 2, 0, 0, 0], [40, 5, 1, 0, 0, 0], [39, 6, 2, 0, 0, 0], [37, 5, 3, 0, 0, 0],
  [35, 7, 1, 0, 0, 0], [36, 6, 3, 0, 0, 0], [38, 5, 2, 0, 0, 0], [37, 6, 1, 0, 0, 0], [39, 5, 3, 0, 0, 0],
  [40, 6, 2, 0, 0, 0], [38, 5, 1, 0, 0, 0], [36, 6, 2, 0, 0, 0], [35, 7, 3, 0, 0, 0],
  [34, 6, 2, 0, 0, 0], [36, 5, 3, 0, 0, 0], [37, 7, 1, 0, 0, 0], [39, 6, 2, 0, 0, 0],
  [120, 40, 20, 82, 82, 0], [130, 50, 25, 121, 121, 0], [0, 0, 0, 0, 0, 30]
];

int maxCharger[STATIONS][TYPES] = [
  [100, 50, 50, 30, 30, 0], [100, 50, 50, 30, 30, 0], [100, 50, 50, 30, 30, 0], [100, 50, 50, 30, 30, 0],
  [100, 50, 50, 30, 30, 0], [50, 30, 30, 0, 0, 10], [100, 50, 50, 30, 30, 0], [80, 40, 40, 20, 20, 0]
];

// Biến quyết định
 dvar int+ x[STATIONS][TYPES];
 dvar boolean y[POINTS][STATIONS];

// Biểu thức mục tiêu
 dexpr float F1 = sum(i in POINTS, j in STATIONS)( y[i][j] * sum(t in TYPES)( EVcount[i][t] * SCF[t] ) );
 dexpr float F2 = alpha * sum(j in STATIONS)( abs( sum(i in POINTS)(y[i][j] * sum(t in TYPES)( EVcount[i][t] * SCF[t] ))
     - (sum(i in POINTS, k in STATIONS)( y[i][k] * sum(t in TYPES)( EVcount[i][t] * SCF[t] )) / card(STATIONS) ) ) );
 dexpr float F3 = beta * sum(j in STATIONS, t in TYPES)( x[j][t] * area[t] );

 minimize w1*(-F1) + w2*F2 + w3*F3;

subject to {
  forall(i in POINTS)
    sum(j in STATIONS)(y[i][j]) <= 1;

  forall(j in STATIONS, t in TYPES)
    x[j][t] <= maxCharger[j][t];

  forall(j in STATIONS, t in TYPES)
    sum(i in POINTS)( y[i][j] * EVcount[i][t] * SCF[t] * power[t] ) <= x[j][t] * power[t];

  forall(j in STATIONS : j != "CC-BDX")
    x[j]["bus"] >= 0;
}

execute {
  writeln("F1 = ", F1);
  writeln("F2 = ", F2);
  writeln("F3 = ", F3);
  writeln("Z  = ", w1*(-F1) + w2*F2 + w3*F3);
}
